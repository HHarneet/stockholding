---
- name: Configure and load session initiation audit rules
  hosts: all
  become: true

  tasks:
    - name: Ensure /etc/audit/rules.d directory exists
      file:
        path: /etc/audit/rules.d
        state: directory
        mode: '0755'

    - name: Define required session audit rules
      set_fact:
        session_rules:
          - "-w /var/run/utmp -p wa -k session"
          - "-w /var/log/wtmp -p wa -k session"
          - "-w /var/log/btmp -p wa -k session"

    - name: Ensure session audit rules exist without duplication
      blockinfile:
        path: /etc/audit/rules.d/50-session.rules
        marker: "# {mark} ANSIBLE MANAGED BLOCK: Session audit rules"
        block: |
          -w /var/run/utmp -p wa -k session
          -w /var/log/wtmp -p wa -k session
          -w /var/log/btmp -p wa -k session
        create: yes
        mode: '0644'

    - name: Load the new audit rules with augenrules
      command: augenrules --load
      register: augenrules_result
      failed_when: augenrules_result.rc != 0 and '"Rule exists"' not in augenrules_result.stderr

    - name: Check if auditd is in immutable mode
      command: auditctl -s
      register: auditctl_status
      changed_when: false
      failed_when: false

    - name: Print if reboot is required
      debug:
        msg: "⚠️ Reboot required to load rules (auditd is in immutable mode)"
      when: "'enabled = 2' in auditctl_status.stdout"

    - name: Ensure auditd service is running
      service:
        name: auditd
        state: started
        enabled: true
