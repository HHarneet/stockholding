---
- name: Ensure use of privileged commands is collected (CIS 5.2.3.6)
  hosts: all
  become: true

  tasks:
    - name: Ensure audit rules for privileged commands are in place
      copy:
        dest: /etc/audit/rules.d/50-privileged-commands.rules
        content: |
          -a always,exit -F arch=b64 -S execve -F uid>=1000 -F euid!=0 -F auid!=unset -k privileged-commands
          -a always,exit -F arch=b32 -S execve -F uid>=1000 -F euid!=0 -F auid!=unset -k privileged-commands
          -a always,exit -F arch=b64 -S execve -F path=/usr/bin/sudo -k privileged-commands
          -a always,exit -F arch=b32 -S execve -F path=/usr/bin/sudo -k privileged-commands

    - name: Remove existing compiled audit.rules (to avoid duplication errors)
      file:
        path: /etc/audit/audit.rules
        state: absent

    - name: Reload audit rules with augenrules
      command: augenrules --load
      register: augenrules_result
      failed_when: augenrules_result.rc != 0 and
                   "'Rule exists' not in augenrules_result.stderr"

    - name: Check if auditd is in immutable mode
      command: auditctl -s
      register: audit_status
      changed_when: false

    - name: Notify if reboot is required due to auditd immutable mode
      debug:
        msg: "⚠️ Auditd is in immutable mode. Reboot is required to apply new rules."
      when: audit_status.stdout is search('enabled[^\\n]*2')
